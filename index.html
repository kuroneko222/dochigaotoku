<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Å©„Å£„Å°„Åå„ÅäÂæóÔºü</title>
    <style>
        /* ==== Ëâ≤„ÅÆË®≠ÂÆöÔºàÂ§âÊï∞Ôºâ ==== */
        :root {
            /* „É©„Ç§„Éà„É¢„Éº„Éâ */
            --bg-color: #f5f5f5;
            --text-color: #202124;
            --title-color: #202124;
            --box-bg: #ffffff;
            --box-shadow: rgba(60,64,67,0.3);
            --border-std: #dadce0;
            
            --input-bg: #fff;
            --input-text: #3c4043;
            --input-border: #dadce0;
            
            --btn-bg: #fff;
            --btn-text: #3c4043;
            --btn-border: #dadce0;
            --del-btn-bg: #fce8e6;
            --del-btn-text: #c5221f;
            
            /* „Çπ„ÉÅ„Éº„É´„Éñ„É´„Éº */
            --calc-btn-bg: #4682B4; 
            --calc-btn-text: #fff;
            
            --result-bg: #fff;
            --winner-hl-bg: #fce8e6;
            --winner-hl-border: #ea4335;
            --winner-text: #ea4335;
            --detail-text: #5f6368;
            
            --label-color: #5f6368;

            /* „É¢„Éº„ÉÄ„É´ */
            --modal-bg: rgba(0,0,0,0.5);
            --modal-content-bg: #fff;
            --history-item-border: #eee;

            /* „Çø„Éñ„ÅÆËâ≤ */
            --tab-bar-bg: #e0e0e0;
            --tab-active-bg: #f5f5f5;
            --tab-inactive-bg: #d0d0d0;
            --tab-text: #555;
            --tab-active-text: #202124;
        }

        /* „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ */
        [data-theme="dark"] {
            --bg-color: #202124;
            --text-color: #E8EAED;
            --title-color: #E8EAED;
            --box-bg: #1B1D21;
            --box-shadow: rgba(0,0,0,0.5);
            --border-std: #5f6368;
            
            --input-bg: #303134; 
            --input-text: #E8EAED;
            --input-border: #5f6368;
            
            --btn-bg: #303134;
            --btn-text: #E8EAED;
            --btn-border: #5f6368;
            --del-btn-bg: #3c1f1f;
            --del-btn-text: #f28b82;
            
            --calc-btn-bg: #6D9DC5; 
            --calc-btn-text: #1a1a1a;
            
            --result-bg: #1B1D21;
            --winner-hl-bg: #3c2f2f;
            --winner-hl-border: #f28b82;
            --winner-text: #f28b82;
            --detail-text: #9aa0a6;
            
            --label-color: #9aa0a6;

            --modal-bg: rgba(0,0,0,0.7);
            --modal-content-bg: #2d2e30;
            --history-item-border: #444;

            --tab-bar-bg: #151515;
            --tab-active-bg: #202124;
            --tab-inactive-bg: #2a2a2a;
            --tab-text: #888;
            --tab-active-text: #E8EAED;
        }

        /* ==== ÂÖ®‰Ωì„ÅÆ„Çπ„Çø„Ç§„É´ ==== */
        body {
            font-family: "Google Sans", Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
            text-align: center;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            margin: 0;
            padding-bottom: 80px;
            transition: background-color 0.3s, color 0.3s;
        }

        h2 { 
            color: var(--title-color); 
            margin-bottom: 15px; 
            margin-top: 10px;
        }
        
        /* „Ç¢„Ç§„Ç≥„É≥„Éú„Çø„É≥ */
        .icon-btn {
            position: absolute;
            top: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: transform 0.2s;
            z-index: 20;
        }
        .icon-btn:active { transform: scale(0.8); }
        #theme-toggle { right: 15px; }
        #history-btn { left: 15px; }

        /* ==== „Çø„ÉñUI ==== */
        #tabs-container {
            display: flex;
            overflow-x: auto;
            background-color: var(--tab-bar-bg);
            padding: 5px 5px 0 5px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
            scrollbar-width: none;
        }
        #tabs-container::-webkit-scrollbar { display: none; }

        .tab-btn {
            background-color: var(--tab-inactive-bg);
            color: var(--tab-text);
            border: none;
            padding: 10px 15px;
            margin-right: 2px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .tab-btn.active {
            background-color: var(--tab-active-bg);
            color: var(--tab-active-text);
            font-weight: bold;
            padding-bottom: 12px;
            margin-bottom: -2px;
            z-index: 5;
        }
        .tab-close {
            font-size: 16px;
            opacity: 0.6;
            line-height: 1;
            border-radius: 50%;
            padding: 0 4px;
        }
        .tab-close:hover { opacity: 1; background-color: rgba(0,0,0,0.1); }
        #add-tab-btn {
            background: none;
            color: var(--tab-text);
            font-size: 20px;
            border: none;
            cursor: pointer;
            padding: 0 10px;
            font-weight: bold;
        }

        /* „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ */
        .tab-content {
            display: none;
            background-color: var(--bg-color);
            padding-top: 15px;
            border-top: 2px solid var(--tab-active-bg);
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ==== ÂïÜÂìÅ„É™„Çπ„Éà„Å™„Å© ==== */
        .product-list { margin-bottom: 10px; }

        .product-box {
            display: flex;
            align-items: center;
            background: var(--box-bg);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px var(--box-shadow);
            border-left: 6px solid var(--border-std);
            transition: background-color 0.3s, border 0.3s;
        }

        .winner-bg {
            background-color: var(--winner-hl-bg) !important;
            border: 1px solid var(--winner-hl-border);
        }
        
        .box-label {
            font-weight: bold;
            font-size: 1.0em;
            color: var(--label-color);
            writing-mode: vertical-rl;
            text-orientation: upright;
            letter-spacing: 2px;
            margin-right: 15px;
            margin-left: 5px;
            min-width: 1.5em;
        }

        .input-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        input {
            width: 90%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--input-text);
            transition: background-color 0.3s;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .sub-btn {
            padding: 8px 24px;
            font-size: 14px;
            border-radius: 18px;
            cursor: pointer;
            border: 1px solid var(--btn-border);
            color: var(--btn-text);
            background-color: var(--btn-bg);
            transition: background-color 0.3s;
            font-weight: 500;
        }
        .del-btn {
            background-color: var(--del-btn-bg);
            color: var(--del-btn-text);
            border-color: transparent;
        }

        .calc-btn {
            background-color: var(--calc-btn-bg);
            color: var(--calc-btn-text);
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            border-radius: 28px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
            letter-spacing: 1px;
        }
        .calc-btn:active { transform: scale(0.98); opacity: 0.9; }

        .result-area {
            margin-top: 25px;
            padding: 20px;
            font-weight: bold;
            font-size: 18px;
            background-color: var(--result-bg);
            border: 1px solid var(--border-std);
            border-radius: 8px;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            line-height: 1.6;
        }
        .winner-text { 
            color: var(--winner-text); 
            font-size: 1.3em; 
            display:block; 
            margin-bottom:10px; 
        }
        .detail-text { 
            color: var(--detail-text); 
            font-size: 0.9em; 
            font-weight: normal; 
            white-space: pre-line; 
        }

        /* ==== Â±•Ê≠¥„É¢„Éº„ÉÄ„É´ ==== */
        #history-modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background-color: var(--modal-content-bg);
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 85%;
            max-width: 400px;
            max-height: 70%;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            text-align: left;
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
        }
        .history-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
        .history-item {
            padding: 15px;
            border-bottom: 1px solid var(--history-item-border);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .history-item:hover { opacity: 0.8; }
        .history-date {
            font-size: 0.8em;
            color: var(--label-color);
            margin-bottom: 5px;
        }
        .history-summary {
            font-weight: bold;
            color: var(--text-color);
            font-size: 1.1em;
        }
        .history-detail {
            font-size: 0.85em;
            color: var(--detail-text);
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #clear-history {
            display: block;
            margin: 20px auto 0;
            background: none;
            border: 1px solid var(--del-btn-text);
            color: var(--del-btn-text);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

    <button id="history-btn" class="icon-btn">üïí</button>
    <button id="theme-toggle" class="icon-btn">üåô</button>

    <h2>üõí „Å©„Å£„Å°„Åå„ÅäÂæóÔºü</h2>

    <div id="tabs-container">
        <button id="add-tab-btn" onclick="addNewTab()">Ôºã</button>
    </div>

    <div id="contents-container"></div>

    <div id="history-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeHistory()">&times;</span>
            <h3 style="margin-top:0; color:var(--text-color);">Ë®àÁÆóÂ±•Ê≠¥</h3>
            <div id="history-list-container" class="history-list"></div>
            <button id="clear-history" onclick="clearHistory()">Â±•Ê≠¥„ÇíÂÖ®„Å¶Ê∂àÂéª</button>
        </div>
    </div>

    <script>
        var COLORS = ['#d65b5b', '#5f9ea0', '#bfb050', '#789eeb', '#cc8e35', '#9c88cc'];
        var CHARS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        
        var tabCounter = 1; 

        window.onload = function() {
            var savedTheme = localStorage.getItem('appTheme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
            }
            addNewTab(); 
        };

        // „ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà
        document.getElementById('theme-toggle').onclick = function() {
            var body = document.body;
            var btn = document.getElementById('theme-toggle');

            if (body.hasAttribute('data-theme')) {
                body.removeAttribute('data-theme');
                btn.textContent = 'üåô';
                localStorage.setItem('appTheme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                btn.textContent = '‚òÄÔ∏è';
                localStorage.setItem('appTheme', 'dark');
            }
        };

        /* ==== „Çø„ÉñÊ©üËÉΩ ==== */
        function addNewTab() {
            var tabId = 'tab-' + tabCounter;
            var contentId = 'content-' + tabCounter;
            var tabNum = tabCounter;
            tabCounter++;

            var btn = document.createElement('button');
            btn.className = 'tab-btn';
            btn.id = tabId;
            btn.onclick = function(e) { 
                if(e.target.className !== 'tab-close') switchTab(tabId, contentId); 
            };
            btn.innerHTML = 'Ë®àÁÆó ' + tabNum + ' <span class="tab-close" onclick="closeTab(\''+tabId+'\', \''+contentId+'\')">√ó</span>';
            
            var addBtn = document.getElementById('add-tab-btn');
            document.getElementById('tabs-container').insertBefore(btn, addBtn);

            var contentDiv = document.createElement('div');
            contentDiv.className = 'tab-content';
            contentDiv.id = contentId;
            
            var html = '';
            html += '<div class="product-list"></div>';
            html += '<div class="control-buttons">';
            html += '<button class="sub-btn" onclick="addProduct(this)">Ôºã ËøΩÂä†</button>';
            html += '<button class="sub-btn del-btn" onclick="removeProduct(this)">Ôºç ÂâäÈô§</button>';
            html += '</div>';
            html += '<button class="calc-btn" onclick="calculate(this)">Ë®àÁÆó„Åô„ÇãÔºÅ</button>';
            html += '<div class="result-area"></div>';

            contentDiv.innerHTML = html;
            document.getElementById('contents-container').appendChild(contentDiv);

            var list = contentDiv.querySelector('.product-list');
            addItemToBox(list); 
            addItemToBox(list); 

            switchTab(tabId, contentId);
        }

        function switchTab(tabId, contentId) {
            var tabs = document.getElementsByClassName('tab-btn');
            for(var i=0; i<tabs.length; i++) tabs[i].classList.remove('active');
            var contents = document.getElementsByClassName('tab-content');
            for(var j=0; j<contents.length; j++) contents[j].classList.remove('active');
            document.getElementById(tabId).classList.add('active');
            document.getElementById(contentId).classList.add('active');
        }

        function closeTab(tabId, contentId) {
            var tabs = document.getElementsByClassName('tab-btn');
            if(tabs.length <= 1) {
                alert("ÊúÄÂæå„ÅÆ„Çø„Éñ„ÅØÊ∂à„Åõ„Åæ„Åõ„Çì");
                return;
            }
            document.getElementById(tabId).remove();
            document.getElementById(contentId).remove();
            if(document.getElementsByClassName('tab-btn active').length === 0) {
                var firstTab = document.getElementsByClassName('tab-btn')[0];
                var num = firstTab.id.split('-')[1];
                switchTab(firstTab.id, 'content-' + num);
            }
        }

        /* ==== ÂïÜÂìÅÊìç‰Ωú ==== */
        function addItemToBox(listElement) {
            var index = listElement.children.length;
            var char = CHARS.charAt(index % 26);
            var color = COLORS[index % COLORS.length];

            var div = document.createElement('div');
            div.className = 'product-box';
            div.style.borderLeftColor = color;
            
            var html = '';
            html += '<div class="box-label">ÂïÜÂìÅ' + char + '</div>';
            html += '<div class="input-area">';
            html += '<input type="number" class="price" placeholder="ÂÄ§ÊÆµ (ÂÜÜ)">';
            html += '<input type="number" class="amount" placeholder="Èáè (g / ÂÄã)">';
            html += '</div>';
            
            div.innerHTML = html;
            listElement.appendChild(div);
        }

        function addProduct(btn) {
            var contentDiv = btn.closest('.tab-content');
            var list = contentDiv.querySelector('.product-list');
            addItemToBox(list);
        }

        function removeProduct(btn) {
            var contentDiv = btn.closest('.tab-content');
            var list = contentDiv.querySelector('.product-list');
            if (list.children.length > 2) {
                list.removeChild(list.lastElementChild);
            } else {
                alert("„Åì„Çå‰ª•‰∏ä„ÅØÊ∏õ„Çâ„Åõ„Åæ„Åõ„Çì");
            }
        }

        function calculate(btn) {
            var contentDiv = btn.closest('.tab-content');
            var boxes = contentDiv.getElementsByClassName('product-box');
            
            var minPrice = 99999999;
            var winnerNames = [];
            var winnerElements = [];
            var details = "";
            var currentData = [];

            for (var i = 0; i < boxes.length; i++) {
                var box = boxes[i];
                var inputs = box.getElementsByTagName('input');
                var priceVal = inputs[0].value;
                var amountVal = inputs[1].value;
                var name = "ÂïÜÂìÅ" + CHARS.charAt(i % 26);

                box.classList.remove('winner-bg');

                if (priceVal == "" || amountVal == "") {
                    alert(name + " „ÅÆÊï∞Â≠ó„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ");
                    return;
                }
                
                currentData.push({
                    price: priceVal,
                    amount: amountVal,
                    name: name
                });

                var p = parseFloat(priceVal);
                var a = parseFloat(amountVal);
                var unitPrice = p / a;

                details += name + ":" + unitPrice.toFixed(2) + "ÂÜÜ\n";

                if (unitPrice < minPrice) {
                    minPrice = unitPrice;
                    winnerNames = [];
                    winnerNames.push(name);
                    winnerElements = [];
                    winnerElements.push(box);
                } else if (unitPrice == minPrice) {
                    winnerNames.push(name);
                    winnerElements.push(box);
                }
            }

            var resultArea = contentDiv.querySelector('.result-area');
            resultArea.style.display = "block";

            var winText = winnerNames.join(" „Å® ");
            var finalHtml = '<div class="winner-text">üéâ ' + winText + ' „Åå„ÅäÂæóÔºÅ</div>';
            finalHtml += '<div class="detail-text">' + details + '</div>';
            
            resultArea.innerHTML = finalHtml;

            for (var j = 0; j < winnerElements.length; j++) {
                winnerElements[j].classList.add('winner-bg');
            }

            saveHistory(winText, currentData);
        }

        /* ==== Â±•Ê≠¥Á≥ªÔºàÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØËøΩÂä†Ôºâ ==== */
        function saveHistory(winner, data) {
            var history = JSON.parse(localStorage.getItem('calcHistory') || '[]');
            
            // ÊØîËºÉÁî®„ÅÆË¶ÅÁ¥Ñ„ÉÜ„Ç≠„Çπ„Éà„Çí‰ΩúÊàêÔºà‰æãÔºö200ÂÜÜ vs 300ÂÜÜÔºâ
            var summary = data.map(function(d){ return d.price + "ÂÜÜ" }).join(" vs ");

            // ‚òÖÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ‚òÖ
            // Â±•Ê≠¥„Åå1‰ª∂‰ª•‰∏ä„ÅÇ„Çä„ÄÅ„Åã„Å§Áõ¥Ââç„ÅÆÂ±•Ê≠¥„Å®„ÄåÂãùËÄÖ„Äç„ÄåÂÜÖÂÆπ„Äç„ÅåÂÖ®„ÅèÂêå„Åò„Å™„Çâ‰øùÂ≠ò„Åó„Å™„ÅÑ
            if (history.length > 0) {
                var lastItem = history[0];
                if (lastItem.winner === winner && lastItem.summary === summary) {
                    return; // „Åì„Åì„ÅßÁµÇ‰∫ÜÔºà‰øùÂ≠ò„Åó„Å™„ÅÑÔºâ
                }
            }

            var now = new Date();
            var dateStr = (now.getMonth()+1) + "/" + now.getDate() + " " + now.getHours() + ":" + String(now.getMinutes()).padStart(2, '0');

            var newItem = {
                date: dateStr,
                winner: winner,
                summary: summary,
                data: data
            };
            history.unshift(newItem);
            if (history.length > 20) history.pop();
            localStorage.setItem('calcHistory', JSON.stringify(history));
        }

        document.getElementById('history-btn').onclick = function() {
            renderHistory();
            document.getElementById('history-modal').style.display = "block";
        };
        function closeHistory() { document.getElementById('history-modal').style.display = "none"; }
        window.onclick = function(event) {
            if (event.target == document.getElementById('history-modal')) closeHistory();
        }

        function renderHistory() {
            var history = JSON.parse(localStorage.getItem('calcHistory') || '[]');
            var container = document.getElementById('history-list-container');
            container.innerHTML = "";
            if (history.length === 0) {
                container.innerHTML = "<div style='padding:20px; color:var(--detail-text);'>„Åæ„Å†Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>";
                return;
            }
            history.forEach(function(item, index) {
                var div = document.createElement('div');
                div.className = 'history-item';
                div.onclick = function() { restoreHistory(index); };
                var html = '<div class="history-date">' + item.date + '</div>';
                html += '<div class="history-summary">üèÜ ' + item.winner + '</div>';
                html += '<div class="history-detail">' + item.summary + '</div>';
                div.innerHTML = html;
                container.appendChild(div);
            });
        }

        function restoreHistory(index) {
            var history = JSON.parse(localStorage.getItem('calcHistory') || '[]');
            var item = history[index];
            var data = item.data;

            var activeContent = document.querySelector('.tab-content.active');
            var list = activeContent.querySelector('.product-list');
            list.innerHTML = "";

            data.forEach(function(d, i) {
                var char = CHARS.charAt(i % 26);
                var color = COLORS[i % COLORS.length];
                var div = document.createElement('div');
                div.className = 'product-box';
                div.style.borderLeftColor = color;
                
                var html = '';
                html += '<div class="box-label">ÂïÜÂìÅ' + char + '</div>';
                html += '<div class="input-area">';
                html += '<input type="number" class="price" placeholder="ÂÄ§ÊÆµ (ÂÜÜ)" value="' + d.price + '">';
                html += '<input type="number" class="amount" placeholder="Èáè (g / ÂÄã)" value="' + d.amount + '">';
                html += '</div>';
                
                div.innerHTML = html;
                list.appendChild(div);
            });

            closeHistory();
            var calcBtn = activeContent.querySelector('.calc-btn');
            calculate(calcBtn);
        }

        function clearHistory() {
            if(confirm("Â±•Ê≠¥„ÇíÂÖ®„Å¶Ê∂à„Åó„Å¶„ÇÇ„ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü")) {
                localStorage.removeItem('calcHistory');
                renderHistory();
            }
        }
    </script>
</body>
</html>
