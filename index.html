<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Å©„Å£„Å°„Åå„ÅäÂæóÔºü</title>
    <style>
        /* ==== Ëâ≤„ÅÆË®≠ÂÆöÔºàÂ§âÊï∞Ôºâ ==== */
        :root {
            /* „É©„Ç§„Éà„É¢„Éº„Éâ */
            --bg-color: #f5f5f5;
            --text-color: #202124;
            --title-color: #202124;
            --box-bg: #ffffff;
            --box-shadow: rgba(60,64,67,0.3);
            --border-std: #dadce0;
            
            --input-bg: #fff;
            --input-text: #3c4043;
            --input-border: #dadce0;
            
            --btn-bg: #fff;
            --btn-text: #3c4043;
            --btn-border: #dadce0;
            --del-btn-bg: #fce8e6;
            --del-btn-text: #c5221f;
            
            /* „Çπ„ÉÅ„Éº„É´„Éñ„É´„Éº */
            --calc-btn-bg: #4682B4; 
            --calc-btn-text: #fff;
            
            --result-bg: #fff;
            --winner-hl-bg: #fce8e6;
            --winner-hl-border: #ea4335;
            --winner-text: #ea4335;
            --detail-text: #5f6368;
            
            --label-color: #5f6368;

            /* „É¢„Éº„ÉÄ„É´ÔºàÂ±•Ê≠¥ÁîªÈù¢Ôºâ„ÅÆËâ≤ */
            --modal-bg: rgba(0,0,0,0.5);
            --modal-content-bg: #fff;
            --history-item-border: #eee;
        }

        /* „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ */
        [data-theme="dark"] {
            --bg-color: #202124;
            --text-color: #E8EAED;
            --title-color: #E8EAED;
            --box-bg: #1B1D21;
            --box-shadow: rgba(0,0,0,0.5);
            --border-std: #5f6368;
            
            --input-bg: #303134; 
            --input-text: #E8EAED;
            --input-border: #5f6368;
            
            --btn-bg: #303134;
            --btn-text: #E8EAED;
            --btn-border: #5f6368;
            --del-btn-bg: #3c1f1f;
            --del-btn-text: #f28b82;
            
            --calc-btn-bg: #6D9DC5; 
            --calc-btn-text: #1a1a1a;
            
            --result-bg: #1B1D21;
            --winner-hl-bg: #3c2f2f;
            --winner-hl-border: #f28b82;
            --winner-text: #f28b82;
            --detail-text: #9aa0a6;
            
            --label-color: #9aa0a6;

            /* „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÊôÇ„ÅÆ„É¢„Éº„ÉÄ„É´ */
            --modal-bg: rgba(0,0,0,0.7);
            --modal-content-bg: #2d2e30;
            --history-item-border: #444;
        }

        /* ==== ÂÖ®‰Ωì„ÅÆ„Çπ„Çø„Ç§„É´ ==== */
        body {
            font-family: "Google Sans", Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
            text-align: center;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            margin: 0;
            padding-bottom: 80px;
            transition: background-color 0.3s, color 0.3s;
        }

        h2 { 
            color: var(--title-color); 
            margin-bottom: 20px; 
            margin-top: 10px;
        }
        
        /* „Ç¢„Ç§„Ç≥„É≥„Éú„Çø„É≥ÂÖ±ÈÄöË®≠ÂÆö */
        .icon-btn {
            position: absolute;
            top: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: transform 0.2s;
            z-index: 10;
        }
        .icon-btn:active { transform: scale(0.8); }

        /* „ÉÜ„Éº„ÉûÂàá„ÇäÊõø„ÅàÔºàÂè≥‰∏äÔºâ */
        #theme-toggle { right: 15px; }

        /* Â±•Ê≠¥„Éú„Çø„É≥ÔºàÂ∑¶‰∏äÔºâ */
        #history-btn { left: 15px; }

        #product-list { margin-bottom: 10px; }

        .product-box {
            display: flex;
            align-items: center;
            background: var(--box-bg);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px var(--box-shadow);
            border-left: 6px solid var(--border-std);
            transition: background-color 0.3s, border 0.3s;
        }

        .winner-bg {
            background-color: var(--winner-hl-bg) !important;
            border: 1px solid var(--winner-hl-border);
        }
        
        .box-label {
            font-weight: bold;
            font-size: 1.0em;
            color: var(--label-color);
            writing-mode: vertical-rl;
            text-orientation: upright;
            letter-spacing: 2px;
            margin-right: 15px;
            margin-left: 5px;
            min-width: 1.5em;
        }

        .input-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        input {
            width: 90%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--input-text);
            transition: background-color 0.3s;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .sub-btn {
            padding: 8px 24px;
            font-size: 14px;
            border-radius: 18px;
            cursor: pointer;
            border: 1px solid var(--btn-border);
            color: var(--btn-text);
            background-color: var(--btn-bg);
            transition: background-color 0.3s;
            font-weight: 500;
        }
        #del-btn {
            background-color: var(--del-btn-bg);
            color: var(--del-btn-text);
            border-color: transparent;
        }

        #calc-btn {
            background-color: var(--calc-btn-bg);
            color: var(--calc-btn-text);
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            border-radius: 28px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
            letter-spacing: 1px;
        }
        #calc-btn:active { transform: scale(0.98); opacity: 0.9; }

        #result-area {
            margin-top: 25px;
            padding: 20px;
            font-weight: bold;
            font-size: 18px;
            background-color: var(--result-bg);
            border: 1px solid var(--border-std);
            border-radius: 8px;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            line-height: 1.6;
        }
        .winner-text { 
            color: var(--winner-text); 
            font-size: 1.3em; 
            display:block; 
            margin-bottom:10px; 
        }
        .detail-text { 
            color: var(--detail-text); 
            font-size: 0.9em; 
            font-weight: normal; 
            white-space: pre-line; 
        }

        /* ==== Â±•Ê≠¥„É¢„Éº„ÉÄ„É´„ÅÆ„Çπ„Çø„Ç§„É´ ==== */
        #history-modal {
            display: none; /* ÊúÄÂàù„ÅØÈö†„Åô */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background-color: var(--modal-content-bg);
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 85%;
            max-width: 400px;
            max-height: 70%;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            text-align: left;
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
        }
        .history-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
        .history-item {
            padding: 15px;
            border-bottom: 1px solid var(--history-item-border);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .history-item:hover {
            opacity: 0.8;
        }
        .history-date {
            font-size: 0.8em;
            color: var(--label-color);
            margin-bottom: 5px;
        }
        .history-summary {
            font-weight: bold;
            color: var(--text-color);
            font-size: 1.1em;
        }
        .history-detail {
            font-size: 0.85em;
            color: var(--detail-text);
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #clear-history {
            display: block;
            margin: 20px auto 0;
            background: none;
            border: 1px solid var(--del-btn-text);
            color: var(--del-btn-text);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

    <button id="history-btn" class="icon-btn">üïí</button>
    <button id="theme-toggle" class="icon-btn">üåô</button>

    <h2>üõí „Å©„Å£„Å°„Åå„ÅäÂæóÔºü</h2>

    <div id="product-list">
        </div>

    <div class="control-buttons">
        <button id="add-btn" class="sub-btn" onclick="addProduct()">Ôºã ËøΩÂä†</button>
        <button id="del-btn" class="sub-btn" onclick="removeProduct()">Ôºç ÂâäÈô§</button>
    </div>

    <button id="calc-btn" onclick="calculate()">Ë®àÁÆó„Åô„ÇãÔºÅ</button>

    <div id="result-area"></div>

    <div id="history-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeHistory()">&times;</span>
            <h3 style="margin-top:0; color:var(--text-color);">Ë®àÁÆóÂ±•Ê≠¥</h3>
            <div id="history-list-container" class="history-list"></div>
            <button id="clear-history" onclick="clearHistory()">Â±•Ê≠¥„ÇíÂÖ®„Å¶Ê∂àÂéª</button>
        </div>
    </div>

    <script>
        var COLORS = ['#d65b5b', '#5f9ea0', '#bfb050', '#789eeb', '#cc8e35', '#9c88cc'];
        var CHARS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

        window.onload = function() {
            var savedTheme = localStorage.getItem('appTheme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
            }
            addProduct();
            addProduct();
        };

        // „ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà
        document.getElementById('theme-toggle').onclick = function() {
            var body = document.body;
            var btn = document.getElementById('theme-toggle');

            if (body.hasAttribute('data-theme')) {
                body.removeAttribute('data-theme');
                btn.textContent = 'üåô';
                localStorage.setItem('appTheme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                btn.textContent = '‚òÄÔ∏è';
                localStorage.setItem('appTheme', 'dark');
            }
        };

        // Â±•Ê≠¥„Éú„Çø„É≥
        document.getElementById('history-btn').onclick = function() {
            renderHistory();
            document.getElementById('history-modal').style.display = "block";
        };

        function closeHistory() {
            document.getElementById('history-modal').style.display = "none";
        }

        // „É¢„Éº„ÉÄ„É´„ÅÆÂ§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        window.onclick = function(event) {
            var modal = document.getElementById('history-modal');
            if (event.target == modal) {
                closeHistory();
            }
        }

        function addProduct() {
            var list = document.getElementById('product-list');
            var index = list.children.length;
            var char = CHARS.charAt(index % 26);
            var color = COLORS[index % COLORS.length];

            var div = document.createElement('div');
            div.className = 'product-box';
            div.style.borderLeftColor = color;
            
            var html = '';
            html += '<div class="box-label">ÂïÜÂìÅ' + char + '</div>';
            html += '<div class="input-area">';
            html += '<input type="number" class="price" placeholder="ÂÄ§ÊÆµ (ÂÜÜ)">';
            html += '<input type="number" class="amount" placeholder="Èáè (g / ÂÄã)">';
            html += '</div>';
            
            div.innerHTML = html;
            list.appendChild(div);
        }

        function removeProduct() {
            var list = document.getElementById('product-list');
            if (list.children.length > 2) {
                list.removeChild(list.lastElementChild);
            } else {
                alert("„Åì„Çå‰ª•‰∏ä„ÅØÊ∏õ„Çâ„Åõ„Åæ„Åõ„Çì");
            }
        }

        function calculate() {
            var boxes = document.getElementsByClassName('product-box');
            var minPrice = 99999999;
            var winnerNames = [];
            var winnerElements = [];
            var details = "";
            
            // Â±•Ê≠¥‰øùÂ≠òÁî®„ÅÆ„Éá„Éº„Çø„É™„Çπ„Éà
            var currentData = [];

            for (var i = 0; i < boxes.length; i++) {
                var box = boxes[i];
                var inputs = box.getElementsByTagName('input');
                var priceVal = inputs[0].value;
                var amountVal = inputs[1].value;
                var name = "ÂïÜÂìÅ" + CHARS.charAt(i % 26);

                box.classList.remove('winner-bg');

                if (priceVal == "" || amountVal == "") {
                    alert(name + " „ÅÆÊï∞Â≠ó„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ");
                    return;
                }
                
                // „Éá„Éº„Çø‰øùÂ≠ò
                currentData.push({
                    price: priceVal,
                    amount: amountVal,
                    name: name
                });

                var p = parseFloat(priceVal);
                var a = parseFloat(amountVal);
                var unitPrice = p / a;

                details += name + ": Âçò‰æ° " + unitPrice.toFixed(2) + "ÂÜÜ\n";

                if (unitPrice < minPrice) {
                    minPrice = unitPrice;
                    winnerNames = [];
                    winnerNames.push(name);
                    winnerElements = [];
                    winnerElements.push(box);
                } else if (unitPrice == minPrice) {
                    winnerNames.push(name);
                    winnerElements.push(box);
                }
            }

            var resultArea = document.getElementById('result-area');
            resultArea.style.display = "block";

            var winText = winnerNames.join(" „Å® ");
            var finalHtml = '<div class="winner-text">üéâ ' + winText + ' „Åå„ÅäÂæóÔºÅ</div>';
            finalHtml += '<div class="detail-text">' + details + '</div>';
            
            resultArea.innerHTML = finalHtml;

            for (var j = 0; j < winnerElements.length; j++) {
                winnerElements[j].classList.add('winner-bg');
            }

            // ‚òÖ„Åì„Åì„ÅßÂ±•Ê≠¥„Å´‰øùÂ≠ò
            saveHistory(winText, currentData);
        }

        // Â±•Ê≠¥„Çí‰øùÂ≠ò„Åô„ÇãÊ©üËÉΩ
        function saveHistory(winner, data) {
            var history = JSON.parse(localStorage.getItem('calcHistory') || '[]');
            var now = new Date();
            var dateStr = (now.getMonth()+1) + "/" + now.getDate() + " " + now.getHours() + ":" + String(now.getMinutes()).padStart(2, '0');

            // „Éá„Éº„Çø„ÅÆÊ¶ÇË¶Å„Çí‰Ωú„ÇãÔºà‰æã: 298ÂÜÜ vs 350ÂÜÜ...Ôºâ
            var summary = data.map(function(d){ return d.price + "ÂÜÜ" }).join(" vs ");

            var newItem = {
                date: dateStr,
                winner: winner,
                summary: summary,
                data: data // Âæ©ÂÖÉÁî®„Éá„Éº„Çø
            };

            // ÂÖàÈ†≠„Å´ËøΩÂä†
            history.unshift(newItem);
            
            // ÊúÄÂ§ß20‰ª∂„Åæ„Åß‰øùÂ≠ò
            if (history.length > 20) {
                history.pop();
            }

            localStorage.setItem('calcHistory', JSON.stringify(history));
        }

        // Â±•Ê≠¥„ÇíË°®Á§∫„Åô„ÇãÊ©üËÉΩ
        function renderHistory() {
            var history = JSON.parse(localStorage.getItem('calcHistory') || '[]');
            var container = document.getElementById('history-list-container');
            container.innerHTML = "";

            if (history.length === 0) {
                container.innerHTML = "<div style='padding:20px; color:var(--detail-text);'>„Åæ„Å†Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>";
                return;
            }

            history.forEach(function(item, index) {
                var div = document.createElement('div');
                div.className = 'history-item';
                div.onclick = function() { restoreHistory(index); };
                
                var html = '<div class="history-date">' + item.date + '</div>';
                html += '<div class="history-summary">üèÜ ' + item.winner + '</div>';
                html += '<div class="history-detail">' + item.summary + '</div>';
                
                div.innerHTML = html;
                container.appendChild(div);
            });
        }

        // Â±•Ê≠¥„ÇíÂæ©ÂÖÉ„Åô„ÇãÊ©üËÉΩ
        function restoreHistory(index) {
            var history = JSON.parse(localStorage.getItem('calcHistory') || '[]');
            var item = history[index];
            var data = item.data;

            // 1. ‰ªä„ÅÆ„É™„Çπ„Éà„Çí„ÇØ„É™„Ç¢
            var list = document.getElementById('product-list');
            list.innerHTML = "";

            // 2. „Éá„Éº„Çø„Å´Âêà„Çè„Åõ„Å¶„Éú„ÉÉ„ÇØ„Çπ„Çí‰Ωú„Çã
            data.forEach(function(d, i) {
                // addProduct„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„Çí„Åì„Åì„ÅßÂÜçÁèæ„Åó„Å¶ÂÄ§„ÇíÂÖ•„Çå„Çã
                var char = CHARS.charAt(i % 26);
                var color = COLORS[i % COLORS.length];

                var div = document.createElement('div');
                div.className = 'product-box';
                div.style.borderLeftColor = color;
                
                var html = '';
                html += '<div class="box-label">ÂïÜÂìÅ' + char + '</div>';
                html += '<div class="input-area">';
                html += '<input type="number" class="price" placeholder="ÂÄ§ÊÆµ (ÂÜÜ)" value="' + d.price + '">';
                html += '<input type="number" class="amount" placeholder="Èáè (g / ÂÄã)" value="' + d.amount + '">';
                html += '</div>';
                
                div.innerHTML = html;
                list.appendChild(div);
            });

            // 3. „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Å¶Ë®àÁÆóÂÆüË°å
            closeHistory();
            calculate(); // „Åì„Çå„Åß‰øùÂ≠ò„ÇÇ„Åï„Çå„Å°„ÇÉ„ÅÜ„Åë„Å©„ÄÅÊúÄÊñ∞Â±•Ê≠¥„Å®„Åó„Å¶‰∏ä„Åå„Çã„ÅÆ„ÅßOK
        }

        function clearHistory() {
            if(confirm("Â±•Ê≠¥„ÇíÂÖ®„Å¶Ê∂à„Åó„Å¶„ÇÇ„ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü")) {
                localStorage.removeItem('calcHistory');
                renderHistory();
            }
        }
    </script>
</body>
</html>
